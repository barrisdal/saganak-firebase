<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grup Sağanak Setlist ⚡</title>
  <style>
    /* Genel body ve font */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
        Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      background: #f5f7fa;
      margin: 20px;
      color: #1d1d1f;
    }

    h1 {
      font-weight: 700;
      font-size: 2rem;
      margin-bottom: 1rem;
      color: #111;
      text-align: center;
      user-select: none;
    }

    .section {
      background: #fff;
      border-radius: 14px;
      padding: 20px 25px;
      box-shadow: 0 4px 14px rgba(0, 0, 0, 0.07);
      margin-bottom: 24px;
      max-width: 760px;
      margin-left: auto;
      margin-right: auto;
    }

    label {
      font-weight: 600;
      font-size: 1rem;
      display: block;
      margin-bottom: 8px;
      color: #3c3c4399;
      user-select: none;
    }

    select, input[type=text], textarea {
      width: 100%;
      padding: 12px 16px;
      font-size: 1rem;
      border-radius: 10px;
      border: 1.5px solid #d1d1d6;
      background: #fefefe;
      transition: border-color 0.3s ease;
      box-sizing: border-box;
      font-weight: 500;
      color: #1c1c1e;
      font-family: inherit;
      outline-offset: 2px;
      user-select: text;
      resize: vertical;
    }
    select:focus, input[type=text]:focus, textarea:focus {
      border-color: #007aff;
      box-shadow: 0 0 6px rgba(0, 122, 255, 0.35);
      outline: none;
    }

    textarea {
      min-height: 140px;
      line-height: 1.5;
      font-family: 'SF Mono', Consolas, "Courier New", monospace;
    }

    /* Buton genel */
    button {
      cursor: pointer;
      border: none;
      border-radius: 20px;
      font-weight: 600;
      font-size: 1rem;
      padding: 10px 18px;
      background-color: #007aff;
      color: white;
      box-shadow: 0 4px 6px rgb(0 122 255 / 0.4);
      transition: background-color 0.25s ease, box-shadow 0.25s ease;
      user-select: none;
      margin: 0 6px 12px 0;
      display: inline-block;
      min-width: 48px;
      text-align: center;
    }
    button:hover, button:focus {
      background-color: #005fcc;
      box-shadow: 0 6px 12px rgb(0 95 204 / 0.5);
      outline: none;
    }

    /* Root ton butonları container */
    .root-buttons {
      margin-top: 14px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      user-select: none;
    }

    /* Root ton butonları */
    .root-buttons button {
      background-color: #e1e1e6;
      color: #1c1c1e;
      box-shadow: none;
      min-width: 40px;
      padding: 8px 14px;
      font-weight: 600;
      border-radius: 14px;
      transition: background-color 0.25s ease, color 0.25s ease;
      box-shadow: 0 0 0 0 transparent;
    }
    .root-buttons button:hover {
      background-color: #007aff;
      color: white;
      box-shadow: 0 4px 14px rgb(0 122 255 / 0.4);
    }
    .root-buttons button.selected {
      background-color: #007aff;
      color: white;
      box-shadow: 0 4px 14px rgb(0 122 255 / 0.6);
    }

    /* Şarkı içeriği */
    #songHtmlContainer {
      background: #fefefe;
      border-radius: 12px;
      border: 1px solid #d1d1d6;
      padding: 14px 18px;
      min-height: 160px;
      font-family: 'SF Mono', Consolas, "Courier New", monospace;
      font-size: 1rem;
      color: #1c1c1e;
      white-space: pre-wrap;
      overflow-wrap: break-word;
      user-select: text;
      margin-top: 12px;
      outline-offset: 2px;
      outline: none;
    }
    #songHtmlContainer:focus {
      border-color: #007aff;
      box-shadow: 0 0 12px rgba(0, 122, 255, 0.3);
    }

    h2.song-title {
      font-weight: 800;
      font-size: 1.4rem;
      margin-bottom: 10px;
      color: #111;
      user-select: text;
    }
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>

  <h1>Grup Sağanak Setlist ⚡</h1>

  <div class="section">
    <label for="categoryFilter">Kategori Filtrele:</label>
    <select id="categoryFilter"><option value="">Tüm Kategoriler</option></select>

    <label for="songsDropdown">Şarkı Seç:</label>
    <select id="songsDropdown"><option value="" disabled selected>Bir şarkı seçin</option></select>

    <label for="editSongCategory">Kategori:</label>
    <select id="editSongCategory"><option value="" disabled selected>Kategori seçin</option></select>

    <button id="saveButton">Kaydet</button>

    <div id="songHtmlContainer" contenteditable="true" spellcheck="false"></div>

    <div class="root-buttons" id="rootButtonsContainer" aria-label="Root Ton Seçimi"></div>
  </div>

  <div class="section">
    <h3>Yeni Şarkı Ekle</h3>
    <label for="newSongName">Şarkı Adı:</label>
    <input type="text" id="newSongName" placeholder="Şarkı adı girin" />

    <label for="newSongCategory">Kategori Seç:</label>
    <select id="newSongCategory"><option value="" disabled selected>Kategori seçin</option></select>

    <label for="newSongHtml">Akorlar ve Şarkı Sözleri (HTML formatında):</label>
    <textarea id="newSongHtml" placeholder="Şarkı akorları ve sözleri HTML olarak"></textarea>

    <button id="addSongButton">Yeni Şarkıyı Ekle</button>
  </div>

  <div class="section">
    <h3>Yeni Kategori Ekle</h3>
    <input type="text" id="newCategoryInput" placeholder="Kategori adı girin" />
    <button id="addCategoryButton">Kategori Ekle</button>
  </div>

<script>
  // Firebase ayarları
  const firebaseConfig = {
    apiKey: "AIzaSyDAhFPe_j750iRzfv96xHAMX488sj6xBTs",
    authDomain: "saganak-24ec8.firebaseapp.com",
    databaseURL: "https://saganak-24ec8-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "saganak-24ec8",
    storageBucket: "saganak-24ec8.firebasestorage.app",
    messagingSenderId: "394236997954",
    appId: "1:394236997954:web:c49ebc99d98722e31b98db",
    measurementId: "G-S1C78RYR9Z"
  };

  // Firebase başlat
  const app = firebase.initializeApp(firebaseConfig);
  const database = firebase.database();

  // Firebase referanslar
  const categoriesRef = database.ref('Categories');
  const songsRef = database.ref('Songs');
  const currentSelectedSongRef = database.ref('CurrentSelectedSong');

  // HTML elementler
  const categoryFilter = document.getElementById('categoryFilter');
  const editSongCategory = document.getElementById('editSongCategory');
  const songsDropdown = document.getElementById('songsDropdown');
  const songHtmlContainer = document.getElementById('songHtmlContainer');
  const saveButton = document.getElementById('saveButton');
  const rootButtonsContainer = document.getElementById('rootButtonsContainer');

  const newSongName = document.getElementById('newSongName');
  const newSongCategory = document.getElementById('newSongCategory');
  const newSongHtml = document.getElementById('newSongHtml');
  const addSongButton = document.getElementById('addSongButton');

  const newCategoryInput = document.getElementById('newCategoryInput');
  const addCategoryButton = document.getElementById('addCategoryButton');

  let allCategories = {};
  let allSongs = {};
  let currentSongId = null;
  let currentSongData = null;

  // Kök notalar
  const rootNotes = ['C', 'C#', 'Db', 'D', 'D#', 'Eb', 'E', 'F', 'F#', 'Gb', 'G', 'G#', 'Ab', 'A', 'A#', 'Bb', 'B'];

  // Akorlar ve varyasyonlar için profesyonel transpoze haritası (temel olarak kök notaya göre transpoze edecek)
  // Burada sadece kök notalar işleniyor, detaylı varyasyonlar da işleniyor.
  const chromaticScaleSharps = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
  const chromaticScaleFlats  = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];

  // Şarkıdaki akorları bulup transpoze eden gelişmiş fonksiyon
  function transposeSong(html, targetRoot) {
    if (!currentSongData) return html;

    // Şarkının mevcut root u
    const currentRoot = currentSongData.Root || 'C';

    // Her iki diziden indeks bulma
    function findIndex(note) {
      let idx = chromaticScaleSharps.indexOf(note);
      if (idx === -1) idx = chromaticScaleFlats.indexOf(note);
      return idx;
    }

    // İndeks farkı
    let currentIndex = findIndex(currentRoot);
    let targetIndex = findIndex(targetRoot);
    if (currentIndex === -1 || targetIndex === -1) return html;

    const step = (targetIndex - currentIndex + 12) % 12;

    // Akorları düzenlemek için Regex (kök akorlar + minör, maj7, sus4, 7, dim vb. suffixler)
    const chordRegex = /\b([A-G]{1}(#|b)?)(m|maj7|m7|7|sus4|sus2|add9|dim|aug|m7b5|m6|6|9|11|13|maj9|maj11|maj13|sus|add)?\b/g;

    function transposeChord(match, root, suffix) {
      let rootIndex = findIndex(root);
      if (rootIndex === -1) return match;
      let newIndex = (rootIndex + step) % 12;
      // Şarp veya bemol tercihi için hedef root notanın biçimine bak:
      let useFlats = targetRoot.includes('b');
      let newRoot = useFlats ? chromaticScaleFlats[newIndex] : chromaticScaleSharps[newIndex];
      return newRoot + (suffix || '');
    }

    return html.replace(chordRegex, (match, root, accidental, suffix) => {
      return transposeChord(match, root + (accidental || ''), suffix || '');
    });
  }

  // Kategorileri yükle ve dropdownları doldur
  function loadCategories() {
    categoriesRef.on('value', snapshot => {
      const data = snapshot.val() || {};
      allCategories = data;

      categoryFilter.innerHTML = '<option value="">Tüm Kategoriler</option>';
      editSongCategory.innerHTML = '<option value="" disabled selected>Kategori seçin</option>';
      newSongCategory.innerHTML = '<option value="" disabled selected>Kategori seçin</option>';

      for (const key in data) {
        const catName = data[key];
        categoryFilter.innerHTML += `<option value="${catName}">${catName}</option>`;
        editSongCategory.innerHTML += `<option value="${catName}">${catName}</option>`;
        newSongCategory.innerHTML += `<option value="${catName}">${catName}</option>`;
      }
    });
  }

  // Şarkıları yükle ve filtreye göre filtrele
  function loadSongs(filterCategory = '') {
    songsRef.on('value', snapshot => {
      const data = snapshot.val() || {};
      allSongs = data;

      songsDropdown.innerHTML = '<option value="" disabled selected>Bir şarkı seçin</option>';

      for (const id in data) {
        const song = data[id];
        if (!filterCategory || (song.Category && song.Category === filterCategory)) {
          songsDropdown.innerHTML += `<option value="${id}">${song.Name}</option>`;
        }
      }
    });
  }

  // Şarkı seçildiğinde Firebase'deki seçimi güncelle
  songsDropdown.addEventListener('change', e => {
    const songId = e.target.value;
    if (!songId) return;
    currentSelectedSongRef.set(songId);
  });

  // Seçili şarkıyı Firebase'den gerçek zamanlı al
  currentSelectedSongRef.on('value', snap => {
    const songId = snap.val();
    if (!songId) return;

    if (songsDropdown.value !== songId) songsDropdown.value = songId;

    songsRef.child(songId).once('value').then(songSnap => {
      const song = songSnap.val();
      if (!song) return;

      currentSongId = songId;
      currentSongData = song;

      // Root default C olsun
      if (!currentSongData.Root) currentSongData.Root = 'C';

      renderSongContent();
      updateRootButtonSelection(currentSongData.Root);

      // Kategori gösterimi
      if (currentSongData.Category) {
        editSongCategory.value = currentSongData.Category;
      } else {
        editSongCategory.value = '';
      }
    });
  });

  // Şarkı içeriğini gösterme (başlık + transpoze edilmiş html)
  function renderSongContent() {
    if (!currentSongData) {
      songHtmlContainer.innerHTML = '';
      return;
    }
    const transposedHtml = transposeSong(currentSongData.Html, currentSongData.Root);
    // Şarkı adı başlık olarak koy
    songHtmlContainer.innerHTML = `<h2 class="song-title">${currentSongData.Name}</h2>\n` + transposedHtml;
  }

  // Root butonlarını oluştur
  function createRootButtons() {
    rootButtonsContainer.innerHTML = '';
    rootNotes.forEach(note => {
      const btn = document.createElement('button');
      btn.textContent = note;
      btn.addEventListener('click', () => {
        if (!currentSongData) return;
        currentSongData.Root = note;
        renderSongContent();
        updateRootButtonSelection(note);
      });
      rootButtonsContainer.appendChild(btn);
    });
  }

  // Root buton seçimi güncelle
  function updateRootButtonSelection(selectedNote) {
    const buttons = rootButtonsContainer.querySelectorAll('button');
    buttons.forEach(btn => {
      if (btn.textContent === selectedNote) btn.classList.add('selected');
      else btn.classList.remove('selected');
    });
  }

  // Yeni şarkı ekleme
  addSongButton.addEventListener('click', () => {
    const name = newSongName.value.trim();
    const category = newSongCategory.value;
    const html = newSongHtml.value.trim();

    if (!name || !category || !html) {
      alert("Lütfen tüm alanları doldurun!");
      return;
    }

    const newKey = songsRef.push().key;
    songsRef.child(newKey).set({
      Name: name,
      Category: category,
      Html: html,
      Root: 'C'
    }).then(() => {
      alert("Yeni şarkı eklendi!");
      newSongName.value = '';
      newSongCategory.value = '';
      newSongHtml.value = '';
    }).catch(e => alert("Hata oluştu: " + e.message));
  });

  // Yeni kategori ekleme
  addCategoryButton.addEventListener('click', () => {
    const catName = newCategoryInput.value.trim();
    if (!catName) {
      alert("Kategori adı boş olamaz!");
      return;
    }
    if (Object.values(allCategories).includes(catName)) {
      alert("Bu kategori zaten var!");
      return;
    }
    categoriesRef.push(catName).then(() => {
      alert("Kategori eklendi!");
      newCategoryInput.value = '';
    }).catch(e => alert("Hata oluştu: " + e.message));
  });

  // Şarkı kaydetme
  saveButton.addEventListener('click', () => {
    if (!currentSongId) {
      alert("Önce şarkı seçin!");
      return;
    }
    currentSongData.Html = songHtmlContainer.innerHTML;
    currentSongData.Category = editSongCategory.value;

    songsRef.child(currentSongId).update({
      Html: currentSongData.Html,
      Category: currentSongData.Category,
      Root: currentSongData.Root
    }).then(() => alert("Şarkı kaydedildi!"))
      .catch(e => alert("Kaydetme hatası: " + e.message));
  });

  // Kategori filtresi değişince şarkıları yeniden yükle
  categoryFilter.addEventListener('change', e => {
    loadSongs(e.target.value);
  });

  createRootButtons();
  loadCategories();
  loadSongs();

</script>

</body>
</html>
