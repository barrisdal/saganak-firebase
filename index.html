<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grup Sağanak Setlist ⚡</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f4f4f4;
    }
    h1 {
      color: #333;
    }
    select, input[type="text"], textarea {
      width: 100%;
      padding: 8px;
      margin: 6px 0 12px;
      font-size: 16px;
      border-radius: 4px;
      border: 1px solid #ddd;
      box-sizing: border-box;
    }
    button {
      padding: 8px 12px;
      margin: 3px 6px 12px 0;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      user-select: none;
    }
    button:hover {
      background-color: #218838;
    }
    #songHtmlContainer {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ccc;
      background-color: #fff;
      min-height: 150px;
      white-space: pre-wrap;
      overflow-wrap: break-word;
      outline: none;
    }
    h2.song-title {
      font-weight: bold;
      margin-bottom: 10px;
    }
    .section {
      background: white;
      padding: 15px;
      margin-bottom: 25px;
      border-radius: 6px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }
    label {
      font-weight: bold;
    }
    #toneButtons {
      margin-bottom: 12px;
    }
    #toneButtons button {
      background-color: #007bff;
    }
    #toneButtons button.active {
      background-color: #0056b3;
    }
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>
  <h1>Grup Sağanak Setlist ⚡</h1>

  <div class="section">
    <label for="categoryFilter">Kategori Filtrele:</label>
    <select id="categoryFilter">
      <option value="">Tüm Kategoriler</option>
    </select>

    <label for="songsDropdown">Şarkı Seç:</label>
    <select id="songsDropdown">
      <option value="" disabled selected>Bir şarkı seçin</option>
    </select>

    <div id="toneButtons" title="Şarkının tonunu seçin">
      <!-- Ton butonları buraya JS ile gelecek -->
    </div>

    <button id="transposeUpButton">1 Ton Yukarı</button>
    <button id="transposeDownButton">1 Ton Aşağı</button>
    <button id="saveButton">Şarkı Düzenlemeyi Kaydet</button>

    <div id="songHtmlContainer" contenteditable="true"></div>
  </div>

  <div class="section">
    <h3>Yeni Şarkı Ekle</h3>
    <label for="newSongName">Şarkı Adı:</label>
    <input type="text" id="newSongName" placeholder="Şarkı adı girin" />

    <label for="newSongCategory">Kategori Seç:</label>
    <select id="newSongCategory">
      <option value="" disabled selected>Kategori seçin</option>
    </select>

    <label for="newSongRoot">Kök Ton (Root Note):</label>
    <select id="newSongRoot">
      <!-- Tüm tonlar burada olacak -->
    </select>

    <label for="newSongHtml">Akorlar ve Şarkı Sözleri (HTML formatında):</label>
    <textarea id="newSongHtml" rows="8" placeholder="Şarkı akorları ve sözleri HTML olarak"></textarea>

    <button id="addSongButton">Yeni Şarkıyı Ekle</button>
  </div>

  <div class="section">
    <h3>Yeni Kategori Ekle</h3>
    <input type="text" id="newCategoryInput" placeholder="Kategori adı girin" />
    <button id="addCategoryButton">Kategori Ekle</button>
  </div>

<script>
  // Firebase ayarları
  const firebaseConfig = {
    apiKey: "AIzaSyDAhFPe_j750iRzfv96xHAMX488sj6xBTs",
    authDomain: "saganak-24ec8.firebaseapp.com",
    databaseURL: "https://saganak-24ec8-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "saganak-24ec8",
    storageBucket: "saganak-24ec8.firebasestorage.app",
    messagingSenderId: "394236997954",
    appId: "1:394236997954:web:c49ebc99d98722e31b98db",
    measurementId: "G-S1C78RYR9Z"
  };

  // Firebase başlat
  const app = firebase.initializeApp(firebaseConfig);
  const database = firebase.database();

  // Firebase referanslar
  const categoriesRef = database.ref('Categories');
  const songsRef = database.ref('Songs');
  const currentSelectedSongRef = database.ref('CurrentSelectedSong');

  // HTML elementler
  const categoryFilter = document.getElementById('categoryFilter');
  const newSongCategory = document.getElementById('newSongCategory');
  const songsDropdown = document.getElementById('songsDropdown');
  const songHtmlContainer = document.getElementById('songHtmlContainer');
  const saveButton = document.getElementById('saveButton');
  const transposeUpButton = document.getElementById('transposeUpButton');
  const transposeDownButton = document.getElementById('transposeDownButton');
  const newSongName = document.getElementById('newSongName');
  const newSongHtml = document.getElementById('newSongHtml');
  const addSongButton = document.getElementById('addSongButton');
  const newCategoryInput = document.getElementById('newCategoryInput');
  const addCategoryButton = document.getElementById('addCategoryButton');
  const newSongRoot = document.getElementById('newSongRoot');
  const toneButtonsDiv = document.getElementById('toneButtons');

  let currentSongId = null;
  let currentSongData = null;
  let currentRoot = null; // Seçili şarkının kök tonu

  // Tüm yarım ton dizisi (enharmonikler dahil değil, eşdeğerleri tek olarak yazdım)
  // Ayrıca Db=C#, Eb=D#, Gb=F#, Ab=G#, Bb=A# kabul edildi.
  const tones = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

  // Akor listesi - temel akorlar ve ekler
  // Bu liste sadece transpoze algoritması için temel tonları tanımlamakta
  // Transpose fonksiyonu akorun kök notasını bu dizide arar, geri kalan kısımlar korunur.
  // Örneğin "Bm7" -> "B" kısmı bulunur, "m7" korunur.
  // Minör, 7li, dim, sus4 gibi eklentiler korunur.
  // Bu sayede çoğu akor transpoze edilebilir.
  // Karmaşık akorlar veya alternatif yazımlar eklenebilir ama bu temel hali çoğu iş görür.

  // Regex ile akor kök notası ve geri kalan kısmı ayıracağız.

  // Fonksiyonlar:

  // Kök notaları transpoze eden fonksiyon
  function transposeChordRoot(root, steps) {
    let index = tones.indexOf(root);
    if (index === -1) return root; // Bulamazsa değiştirme
    let newIndex = (index + steps) % tones.length;
    if (newIndex < 0) newIndex += tones.length;
    return tones[newIndex];
  }

  // Akoru kök notası ve eklentisine ayıran regex
  // Örnekler: A, Am, A7, A#m7, Bbmaj7, Gsus4, F#dim, Cadd9 ...
  // Kök notası: A, A#, Bb, C, C# ...
  // Eklenti: geri kalan
  function splitChord(chord) {
    const match = chord.match(/^([A-G](#|b)?)(.*)$/);
    if (!match) return [chord, ''];
    return [match[1], match[3]];
  }

  // Şarkı içindeki tüm akorları transpoze eden fonksiyon
  // HTML içinde <span id='nota'> veya başka yerde olabilir.
  // Şarkı HTML'sindeki akorları regex ile bulup değiştiriyoruz.
  function transposeSong(html, steps) {
    // Regex: Akorları bulmak için, harf ve sembollerden oluşan akorlar.
    // Burada id='nota' span içinde akorlar olabilir.
    // Basitçe <span id='nota' ...>Akorkodu</span> içindeki akorları değiştiriyoruz.
    // Ayrıca başka yerlerdeki akorlar için de (\b akor \b) tarzı basit arama yapılabilir.

    // Bu fonksiyon tüm akorları bulup transpoze eder.

    return html.replace(/<span id=['"]nota['"][^>]*>([^<]+)<\/span>/gi, (match, chordText) => {
      // Örneğin chordText = "Am", "C#", "G7" vb.
      // Bunu parçala
      let [root, suffix] = splitChord(chordText.trim());
      let newRoot = transposeChordRoot(root, steps);
      return `<span id='nota' style='font-weight: bold;'>${newRoot}${suffix}</span>`;
    });
  }

  // Ton butonlarını oluştur
  function createToneButtons() {
    toneButtonsDiv.innerHTML = '';
    tones.forEach(tone => {
      const btn = document.createElement('button');
      btn.textContent = tone;
      btn.title = `Ton: ${tone}`;
      btn.addEventListener('click', () => {
        if (!currentRoot) {
          alert('Önce bir şarkı seçin!');
          return;
        }
        if (tone === currentRoot) return; // Aynı tona basılırsa işlem yok
        const currentIndex = tones.indexOf(currentRoot);
        const newIndex = tones.indexOf(tone);
        const steps = newIndex - currentIndex;
        const transposed = transposeSong(songHtmlContainer.innerHTML, steps);
        songHtmlContainer.innerHTML = transposed;
        currentRoot = tone;
        updateActiveToneButton();
      });
      toneButtonsDiv.appendChild(btn);
    });
  }

  function updateActiveToneButton() {
    const buttons = toneButtonsDiv.querySelectorAll('button');
    buttons.forEach(btn => {
      if (btn.textContent === currentRoot) {
        btn.classList.add('active');
      } else {
        btn.classList.remove('active');
      }
    });
  }

  // Kategorileri yükle ve dropdownları doldur
  let allCategories = {};
  categoriesRef.on('value', snapshot => {
    const data = snapshot.val() || {};
    allCategories = data;

    // Filtre dropdown doldur
    categoryFilter.innerHTML = '<option value="">Tüm Kategoriler</option>';
    newSongCategory.innerHTML = '<option value="" disabled selected>Kategori seçin</option>';

    for (const key in data) {
      const catName = data[key];
      categoryFilter.innerHTML += `<option value="${catName}">${catName}</option>`;
      newSongCategory.innerHTML += `<option value="${catName}">${catName}</option>`;
    }
  });

  // Ton dropdown doldur
  function fillRootDropdown() {
    newSongRoot.innerHTML = '';
    tones.forEach(tone => {
      newSongRoot.innerHTML += `<option value="${tone}">${tone}</option>`;
    });
  }
  fillRootDropdown();

  // Şarkıları yükle, kategori filtresine göre filtrele ve dropdowna ekle
  let allSongs = {};
  songsRef.on('value', snapshot => {
    const data = snapshot.val() || {};
    allSongs = data;

    // Dropdown temizle
    songsDropdown.innerHTML = '<option value="" disabled selected>Bir şarkı seçin</option>';

    for (const songId in data) {
      const song = data[songId];
      // Kategori filtre varsa uygunsa göster, yoksa tümünü göster
      if (!categoryFilter.value || (song.Category && song.Category === categoryFilter.value)) {
        songsDropdown.innerHTML += `<option value="${songId}">${song.Name}</option>`;
      }
    }
  });

  // Şarkı seçildiğinde veriyi göster ve içerik editöre yaz
  songsDropdown.addEventListener('change', e => {
    const songId = e.target.value;
    if (!songId) return;
    currentSelectedSongRef.set(songId); // Gerçek zamanlı seçimi güncelle
  });

  // Firebase üzerinden gerçek zamanlı şarkı seçimi dinleme
  currentSelectedSongRef.on('value', snapshot => {
    const songId = snapshot.val();
    if (!songId) return;

    if (songsDropdown.value !== songId) {
      songsDropdown.value = songId;

      songsRef.child(songId).once('value').then(songSnap => {
        const song = songSnap.val();
        if (!song) return;
        currentSongId = songId;
        currentSongData = song;
        currentRoot = song.Root || tones[0]; // Kök tonu yoksa C yap

        // Şarkı HTML'ine başlığa şarkı adını ekle (bold)
        const titleHtml = `<h2 class="song-title">${song.Name}</h2>`;
        songHtmlContainer.innerHTML = titleHtml + (song.Html || '');

        // Kök tonu aktif ton butonunda göster
        updateActiveToneButton();

        // Seçili kategoriyi güncelle
        if (song.Category && Object.values(allCategories).includes(song.Category)) {
          categoryFilter.value = song.Category;
        } else {
          categoryFilter.value = '';
        }
      });
    }
  });

  // Kategori filtreleme değişince şarkıları filtrele
  categoryFilter.addEventListener('change', e => {
    // Seçilen kategoriye göre şarkıları filtrele
    songsRef.once('value').then(snapshot => {
      const data = snapshot.val() || {};
      songsDropdown.innerHTML = '<option value="" disabled selected>Bir şarkı seçin</option>';

      for (const songId in data) {
        const song = data[songId];
        if (!categoryFilter.value || (song.Category && song.Category === categoryFilter.value)) {
          songsDropdown.innerHTML += `<option value="${songId}">${song.Name}</option>`;
        }
      }
    });
  });

  // Yeni şarkı ekleme işlemi
  addSongButton.addEventListener('click', () => {
    const name = newSongName.value.trim();
    const category = newSongCategory.value;
    const root = newSongRoot.value;
    const html = newSongHtml.value.trim();

    if (!name || !category || !html || !root) {
      alert("Lütfen tüm alanları doldurun!");
      return;
    }

    const newSongKey = songsRef.push().key;
    songsRef.child(newSongKey).set({
      Name: name,
      Category: category,
      Root: root,
      Html: html // HTML içine şarkı adını biz gösteriyoruz, burada ayrı tutuyoruz.
    }).then(() => {
      alert("Yeni şarkı eklendi!");
      newSongName.value = '';
      newSongCategory.value = '';
      newSongHtml.value = '';
      newSongRoot.value = tones[0];
    }).catch(e => {
      alert("Hata oluştu: " + e.message);
    });
  });

  // Yeni kategori ekleme işlemi
  addCategoryButton.addEventListener('click', () => {
    const catName = newCategoryInput.value.trim();
    if (!catName) {
      alert("Kategori adı boş olamaz!");
      return;
    }
    // Aynı kategori varsa ekleme
    if (Object.values(allCategories).includes(catName)) {
      alert("Bu kategori zaten var!");
      return;
    }
    // Firebase'e kategori ekle
    categoriesRef.push(catName).then(() => {
      alert("Kategori eklendi!");
      newCategoryInput.value = '';
    }).catch(e => {
      alert("Hata oluştu: " + e.message);
    });
  });

  // Şarkı düzenlemesi kaydetme (HTML ve kategori ve root da kaydet)
  saveButton.addEventListener('click', () => {
    if (!currentSongId) {
      alert("Önce bir şarkı seçin!");
      return;
    }
    const editedHtml = songHtmlContainer.innerHTML.trim();
    if (!editedHtml) {
      alert("Şarkı içeriği boş olamaz!");
      return;
    }
    // Kategoriyi al (filter dropdown'dan)
    const cat = categoryFilter.value || null;
    // Root tonu da güncelle (active ton butonundan)
    const root = currentRoot || tones[0];

    songsRef.child(currentSongId).update({
      Html: editedHtml,
      Category: cat,
      Root: root
    }).then(() => {
      alert("Şarkı güncellendi!");
    }).catch(e => {
      alert("Güncellerken hata: " + e.message);
    });
  });

  // Ton transpoze butonları (1 ton yukarı aşağı)
  transposeUpButton.addEventListener('click', () => {
    if (!currentRoot) {
      alert("Önce bir şarkı seçin!");
      return;
    }
    const currentIndex = tones.indexOf(currentRoot);
    const newIndex = (currentIndex + 1) % tones.length;
    const newTone = tones[newIndex];
    const transposed = transposeSong(songHtmlContainer.innerHTML, 1);
    songHtmlContainer.innerHTML = transposed;
    currentRoot = newTone;
    updateActiveToneButton();
  });

  transposeDownButton.addEventListener('click', () => {
    if (!currentRoot) {
      alert("Önce bir şarkı seçin!");
      return;
    }
    const currentIndex = tones.indexOf(currentRoot);
    let newIndex = currentIndex - 1;
    if (newIndex < 0) newIndex = tones.length - 1;
    const newTone = tones[newIndex];
    const transposed = transposeSong(songHtmlContainer.innerHTML, -1);
    songHtmlContainer.innerHTML = transposed;
    currentRoot = newTone;
    updateActiveToneButton();
  });

  // Başlangıçta ton butonlarını oluştur
  createToneButtons();

</script>

</body>
</html>
