<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Setlist Root Tonlu Versiyon</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
    .section { background: white; padding: 15px; border-radius: 6px; margin-bottom: 20px; box-shadow: 0 0 8px rgba(0,0,0,0.1); }
    select, input[type=text], textarea { width: 100%; padding: 8px; margin: 6px 0 12px; font-size: 16px; border-radius: 4px; border: 1px solid #ddd; box-sizing: border-box; }
    button { padding: 8px 12px; margin: 4px 3px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background-color: #218838; }
    #songHtmlContainer { min-height: 150px; background: #fff; border: 1px solid #ccc; padding: 10px; white-space: pre-wrap; overflow-wrap: break-word; }
    .root-buttons { margin-top: 10px; }
    .root-buttons button { background-color: #007bff; }
    .root-buttons button.selected { background-color: #0056b3; font-weight: bold; }
    h2.song-title { font-weight: bold; margin-bottom: 10px; }
    label { font-weight: bold; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>

  <h1>Setlist - Root Ton Butonlu Versiyon</h1>

  <div class="section">
    <label for="categoryFilter">Kategori Filtrele:</label>
    <select id="categoryFilter"><option value="">Tüm Kategoriler</option></select>

    <label for="songsDropdown">Şarkı Seç:</label>
    <select id="songsDropdown"><option value="" disabled selected>Bir şarkı seçin</option></select>

    <label for="editSongCategory">Kategori:</label>
    <select id="editSongCategory"><option value="" disabled selected>Kategori seçin</option></select>

    <button id="saveButton">Kaydet</button>

    <div id="songHtmlContainer" contenteditable="true"></div>

    <div class="root-buttons" id="rootButtonsContainer" aria-label="Root Ton Seçimi">
      <!-- Root butonları buraya JS ile gelecek -->
    </div>
  </div>

<script>
  // Firebase ayarları
  const firebaseConfig = {
    apiKey: "AIzaSyDAhFPe_j750iRzfv96xHAMX488sj6xBTs",
    authDomain: "saganak-24ec8.firebaseapp.com",
    databaseURL: "https://saganak-24ec8-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "saganak-24ec8",
    storageBucket: "saganak-24ec8.firebasestorage.app",
    messagingSenderId: "394236997954",
    appId: "1:394236997954:web:c49ebc99d98722e31b98db",
    measurementId: "G-S1C78RYR9Z"
  };

  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();

  const categoriesRef = database.ref('Categories');
  const songsRef = database.ref('Songs');
  const currentSelectedSongRef = database.ref('CurrentSelectedSong');

  const categoryFilter = document.getElementById('categoryFilter');
  const editSongCategory = document.getElementById('editSongCategory');
  const songsDropdown = document.getElementById('songsDropdown');
  const songHtmlContainer = document.getElementById('songHtmlContainer');
  const saveButton = document.getElementById('saveButton');
  const rootButtonsContainer = document.getElementById('rootButtonsContainer');

  let allCategories = {};
  let allSongs = {};
  let currentSongId = null;
  let currentSongData = null;

  // Akor dizisi (köşeli, sharp ve flat) - bu sırayı koru!
  const notesSharp = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
  const notesFlat  = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];

  // Helper: Nota index bul (sharp veya flat olabilir)
  function findNoteIndex(note) {
    let idx = notesSharp.indexOf(note);
    if (idx !== -1) return idx;
    idx = notesFlat.indexOf(note);
    return idx;
  }

  // Gelişmiş akor transpoze: kökü değiştir, suffix'i koru
  function transposeChord(chord, semitones) {
    // Akoru parçalara ayır: kök nota + suffix
    // Örnek: "A#m7", "Dbmaj7", "Gdim", "Fsus4" vb.
    const match = chord.match(/^([A-G](?:#|b)?)(.*)$/);
    if (!match) return chord; // eşleşmezse olduğu gibi dön

    let [_, root, suffix] = match;
    let idx = findNoteIndex(root);
    if (idx === -1) return chord; // bilinmeyen kök

    let newIdx = (idx + semitones + 12) % 12;

    // Tercihen sharp notaları kullan (veya flat ile tutarlı)
    let newRoot = notesSharp[newIdx];

    return newRoot + suffix;
  }

  // Şarkı içeriğinde tüm akorları değiştir
  function transposeSongHtml(html, semitones) {
    // Akorlar normalde metinde tek tek yazılır. Regex ile akorları yakala
    // Akor örnekleri: A, Am, A7, A#m7, Ddim, Fsus4 ...
    // Burada akorlar HTML içinde olabilir, biz sadece metin olarak yakalıyoruz.
    return html.replace(/\b([A-G](?:#|b)?(?:m|maj7|dim|aug|sus2|sus4|add9|7|m7)?\d*)\b/g, (match) => {
      return transposeChord(match, semitones);
    });
  }

  // Root butonları oluştur
  function createRootButtons() {
    rootButtonsContainer.innerHTML = '';
    notesSharp.forEach(note => {
      const btn = document.createElement('button');
      btn.textContent = note;
      btn.type = 'button';
      btn.addEventListener('click', () => {
        if(!currentSongData) return alert("Önce şarkı seçin!");
        if (currentSongData.Root === note) return; // aynı root ise işlem yapma
        // Transpoze miktarını hesapla
        let oldRoot = currentSongData.Root || 'C';
        let oldIdx = findNoteIndex(oldRoot);
        let newIdx = findNoteIndex(note);
        if(oldIdx === -1) oldIdx = 0;
        if(newIdx === -1) newIdx = 0;
        const diff = newIdx - oldIdx;

        // Güncelle ve göster
        currentSongData.Root = note;
        currentSongData.Html = transposeSongHtml(currentSongData.Html, diff);

        // Güncellenmiş HTML'i göster
        renderSongContent();

        // Root butonları seçimini güncelle
        updateRootButtonSelection(note);

        // Firebase'e kaydet
        songsRef.child(currentSongId).update({
          Html: currentSongData.Html,
          Root: note
        }).catch(e => alert('Kayıt Hatası: '+ e.message));
      });
      rootButtonsContainer.appendChild(btn);
    });
  }

  // Root butonlarında seçiliyi göster
  function updateRootButtonSelection(selectedRoot) {
    Array.from(rootButtonsContainer.children).forEach(btn => {
      btn.classList.toggle('selected', btn.textContent === selectedRoot);
    });
  }

  // Şarkı içeriği göster
  function renderSongContent() {
    if(!currentSongData) return;
    let htmlWithTitle = `<h2 class="song-title">${currentSongData.Name}</h2>\n${currentSongData.Html}`;
    songHtmlContainer.innerHTML = htmlWithTitle;
  }

  // Kategorileri yükle
  function loadCategories() {
    categoriesRef.on('value', snap => {
      allCategories = snap.val() || {};
      categoryFilter.innerHTML = '<option value="">Tüm Kategoriler</option>';
      editSongCategory.innerHTML = '<option value="" disabled selected>Kategori seçin</option>';
      Object.values(allCategories).forEach(c => {
        categoryFilter.innerHTML += `<option value="${c}">${c}</option>`;
        editSongCategory.innerHTML += `<option value="${c}">${c}</option>`;
      });
    });
  }

  // Şarkıları yükle ve filtrele
  function loadSongs(filterCategory = '') {
    songsRef.on('value', snap => {
      allSongs = snap.val() || {};
      songsDropdown.innerHTML = '<option value="" disabled selected>Bir şarkı seçin</option>';
      Object.entries(allSongs).forEach(([id, song]) => {
        if (!filterCategory || (song.Category && song.Category === filterCategory)) {
          songsDropdown.innerHTML += `<option value="${id}">${song.Name}</option>`;
        }
      });
    });
  }

  // Şarkı seçildiğinde
  songsDropdown.addEventListener('change', e => {
    const songId = e.target.value;
    if (!songId) return;
    currentSelectedSongRef.set(songId); // Tüm cihazlarda senkron için firebase'de sakla
  });

  // Tüm cihazlarda seçili şarkı değişimini dinle
  currentSelectedSongRef.on('value', snap => {
    const songId = snap.val();
    if (!songId) return;

    if (songsDropdown.value !== songId) songsDropdown.value = songId;

    songsRef.child(songId).once('value').then(songSnap => {
      const song = songSnap.val();
      if (!song) return;

      currentSongId = songId;
      currentSongData = song;

      // Root yoksa C yap
      if (!currentSongData.Root) currentSongData.Root = 'C';

      renderSongContent();
      updateRootButtonSelection(currentSongData.Root);
      editSongCategory.value = currentSongData.Category || '';
    });
  });

  // Kategori filtreleme
  categoryFilter.addEventListener('change', e => {
    loadSongs(e.target.value);
  });

  // Kaydet butonu
  saveButton.addEventListener('click', () => {
    if (!currentSongId) return alert("Önce şarkı seçin!");

    // Song HTML zaten root ile güncel, sadece kategoriyi ekle
    songsRef.child(currentSongId).update({
      Html: currentSongData.Html,
      Category: editSongCategory.value,
      Root: currentSongData.Root
    }).then(() => alert("Şarkı kaydedildi!"))
    .catch(e => alert("Kayıt hatası: " + e.message));
  });

  // Başlangıçta root butonları oluştur ve verileri yükle
  createRootButtons();
  loadCategories();
  loadSongs();

</script>

</body>
</html>
