<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Şarkı Yöneticisi</title>
  <style>
    #songHtmlContainer { border: 1px solid #ccc; padding: 20px; margin-top: 20px; min-height: 200px; }
    .song-title { font-weight: bold; font-size: 20px; margin-bottom: 10px; }
  </style>
</head>
<body>
  <h1>Şarkı Yöneticisi</h1>

  <!-- Kategori Seç Dropdown -->
  <label>Kategori Seç:</label>
  <select id="categoryDropdown"></select>

  <!-- Şarkı Seç Dropdown -->
  <label>Şarkı Seç:</label>
  <select id="songsDropdown"></select>

  <!-- Transpoze -->
  <label>Transpoze Değeri:</label>
  <input type="number" id="transposeInput" value="0" />
  <button id="transposeBtn">Transpoze Et</button>

  <!-- Şarkı Düzenleme -->
  <div id="songHtmlContainer" contenteditable="true"></div>
  <button id="saveBtn">Değişiklikleri Kaydet</button>

  <!-- Yeni Şarkı Ekle -->
  <h2>Yeni Şarkı Ekle</h2>
  <input type="text" id="newSongName" placeholder="Şarkı Adı" />
  <textarea id="newSongHtml" placeholder="Şarkı HTML"></textarea>
  <label>Kategori Seç:</label>
  <select id="newSongCategoryDropdown"></select>
  <button id="addSongBtn">Şarkı Ekle</button>

  <!-- Yeni Kategori Ekle -->
  <h2>Yeni Kategori Ekle</h2>
  <input type="text" id="newCategoryName" placeholder="Kategori Adı" />
  <button id="addCategoryBtn">Kategori Ekle</button>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script>
    // Firebase config senin yapılandırmana göre olmalı
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      databaseURL: "YOUR_DATABASE_URL",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);

    const db = firebase.database();
    const songsRef = db.ref('songs');
    const categoriesRef = db.ref('categories');
    const currentSelectedSongRef = db.ref('CurrentSelectedSong');

    const songsDropdown = document.getElementById('songsDropdown');
    const categoryDropdown = document.getElementById('categoryDropdown');
    const newSongCategoryDropdown = document.getElementById('newSongCategoryDropdown');
    const transposeInput = document.getElementById('transposeInput');
    const transposeBtn = document.getElementById('transposeBtn');
    const songHtmlContainer = document.getElementById('songHtmlContainer');
    const saveBtn = document.getElementById('saveBtn');
    const addSongBtn = document.getElementById('addSongBtn');
    const newSongName = document.getElementById('newSongName');
    const newSongHtml = document.getElementById('newSongHtml');
    const newCategoryName = document.getElementById('newCategoryName');
    const addCategoryBtn = document.getElementById('addCategoryBtn');

    let currentSongId = '';
    let currentSongData = {};

    // Şarkıları listele
    songsRef.on('value', snap => {
      songsDropdown.innerHTML = '<option value="">Şarkı Seç</option>';
      snap.forEach(songSnap => {
        const song = songSnap.val();
        const option = document.createElement('option');
        option.value = songSnap.key;
        option.textContent = song.Name;
        songsDropdown.appendChild(option);
      });
    });

    // Kategorileri listele
    categoriesRef.on('value', snap => {
      categoryDropdown.innerHTML = '<option value="">Kategori Seç</option>';
      newSongCategoryDropdown.innerHTML = '<option value="">Kategori Seç</option>';
      snap.forEach(catSnap => {
        const cat = catSnap.val();
        const option1 = document.createElement('option');
        const option2 = document.createElement('option');
        option1.value = catSnap.key;
        option2.value = catSnap.key;
        option1.textContent = cat.Name;
        option2.textContent = cat.Name;
        categoryDropdown.appendChild(option1);
        newSongCategoryDropdown.appendChild(option2);
      });
    });

    // Şarkı seçildiğinde: hem göster hem Firebase'e yaz
    songsDropdown.addEventListener('change', e => {
      const songId = e.target.value;
      if (!songId) return;

      songsRef.child(songId).once('value').then(songSnap => {
        const song = songSnap.val();
        if (!song) return;

        currentSongId = songId;
        currentSongData = song;

        const titleHtml = `<h2 class="song-title">${song.Name}</h2>`;
        songHtmlContainer.innerHTML = titleHtml + song.Html;

        currentSelectedSongRef.set(songId);
      });
    });

    // CurrentSelectedSong dinleyici
    currentSelectedSongRef.on('value', snap => {
      const songId = snap.val();
      if (!songId) return;

      songsRef.child(songId).once('value').then(songSnap => {
        const song = songSnap.val();
        if (!song) return;

        currentSongId = songId;
        currentSongData = song;

        songsDropdown.value = songId;
        const titleHtml = `<h2 class="song-title">${song.Name}</h2>`;
        songHtmlContainer.innerHTML = titleHtml + song.Html;
      });
    });

    // Transpoze
    transposeBtn.addEventListener('click', () => {
      const semitones = parseInt(transposeInput.value);
      if (!currentSongId || !currentSongData.Html) return;

      const transposedHtml = transposeChords(currentSongData.Html, semitones);
      const titleHtml = `<h2 class="song-title">${currentSongData.Name}</h2>`;
      songHtmlContainer.innerHTML = titleHtml + transposedHtml;

      // Güncel şarkıya kaydet
      songsRef.child(currentSongId).update({ Html: transposedHtml });
    });

    // Transpoze fonksiyonu
    function transposeChords(html, semitones) {
      const chords = ['C', 'C#', 'Db', 'D', 'D#', 'Eb', 'E', 'F', 'F#', 'Gb', 'G', 'G#', 'Ab', 'A', 'A#', 'Bb', 'B'];
      const regex = /<span id='nota'.*?>(.*?)<\/span>/g;
      return html.replace(regex, (match, p1) => {
        const chord = p1.trim();
        const idx = chords.findIndex(c => c === chord);
        if (idx === -1) return match;
        let newIdx = idx + semitones;
        while (newIdx < 0) newIdx += chords.length;
        newIdx %= chords.length;
        return match.replace(chord, chords[newIdx]);
      });
    }

    // Şarkı düzenleme kaydet
    saveBtn.addEventListener('click', () => {
      if (!currentSongId) return;
      const updatedHtml = songHtmlContainer.innerHTML.replace(/<h2.*<\/h2>/, '');
      songsRef.child(currentSongId).update({ Html: updatedHtml });
      alert('Şarkı güncellendi.');
    });

    // Yeni şarkı ekle
    addSongBtn.addEventListener('click', () => {
      const name = newSongName.value.trim();
      const html = newSongHtml.value.trim();
      const cat = newSongCategoryDropdown.value;
      if (!name || !html) return;

      const titleHtml = `<h2 class="song-title">${name}</h2>`;
      const fullHtml = titleHtml + html;

      songsRef.push({ Name: name, Html: fullHtml, Category: cat || '' });
      newSongName.value = '';
      newSongHtml.value = '';
      alert('Yeni şarkı eklendi.');
    });

    // Yeni kategori ekle
    addCategoryBtn.addEventListener('click', () => {
      const catName = newCategoryName.value.trim();
      if (!catName) return;

      categoriesRef.push({ Name: catName });
      newCategoryName.value = '';
      alert('Yeni kategori eklendi.');
    });

  </script>
</body>
</html>
